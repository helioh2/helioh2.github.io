<!DOCTYPE html>
<html>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Postar em múltiplos grupos no Facebook</title>
<meta name="robots" content="noindex, nofollow">
<!-- Bootstrap -->
<link
	href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"
	rel="stylesheet">
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
</head>
<body onload="start()">
	<script src="./jquery-1.11.2.min.js"></script>
	<script>
		var countFilters = 4;
		
	
		function start() {
			$('input#addFilter').on('click', function() {
				add_item();
			});
			$('input#filterGroups').on('click', function() {
				filterGroups();
			});
			countFilters = 4;
			
			var groupList = document.getElementById('groups');
			var opt1 = document.createElement("option");
			opt1.value = "001";
			opt1.innerHTML = "Espiritismo Idiota";
			groupList.appendChild(opt1);
			
			var opt2 = document.createElement("option");
			opt2.value = "002";
			opt2.innerHTML = "Rosa Bosta";
			groupList.appendChild(opt2);
			
			var opt3 = document.createElement("option");
			opt3.value = "003";
			opt3.innerHTML = "Jesus Cristo é o Senhor";
			groupList.appendChild(opt3);
		}

		// This is called with the results from from FB.getLoginStatus().
		function statusChangeCallback(response) {
			console.log('statusChangeCallback');
			console.log(response);
			// The response object is returned with a status field that lets the
			// app know the current login status of the person.
			// Full docs on the response object can be found in the documentation
			// for FB.getLoginStatus().
			if (response.status === 'connected') {
				// Logged into your app and Facebook.
				testAPI();
			} else if (response.status === 'not_authorized') {
				// The person is logged into Facebook, but not your app.
				document.getElementById('status').innerHTML = 'Please log '
						+ 'into this app.';
			} else {
				// The person is not logged into Facebook, so we're not sure if
				// they are logged into this app or not.
				document.getElementById('status').innerHTML = 'Please log '
						+ 'into Facebook.';
			}
		}
		// This function is called when someone finishes with the Login
		// Button. See the onlogin handler attached to it in the sample
		// code below.
		function checkLoginState() {
			FB.getLoginStatus(function(response) {
				statusChangeCallback(response);
			});
		}
		window.fbAsyncInit = function() {
			FB.init({
				appId : '346547908847956',
				cookie : true, // enable cookies to allow the server to access 
				// the session
				xfbml : true, // parse social plugins on this page
				version : 'v2.1' // use version 2.1
			});
			// Now that we've initialized the JavaScript SDK, we call
			// FB.getLoginStatus(). This function gets the state of the
			// person visiting this page and can return one of three states to
			// the callback you provide. They can be:
			//
			// 1. Logged into your app ('connected')
			// 2. Logged into Facebook, but not your app ('not_authorized')
			// 3. Not logged into Facebook and can't tell if they are logged into
			// your app or not.
			//
			// These three cases are handled in the callback function.
			FB.getLoginStatus(function(response) {
				statusChangeCallback(response);
			});
		};
		// Load the SDK asynchronously
		(function(d, s, id) {
			var js, fjs = d.getElementsByTagName(s)[0];
			if (d.getElementById(id))
				return;
			js = d.createElement(s);
			js.id = id;
			js.src = "//connect.facebook.net/en_US/sdk.js";
			fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));
		// Here we run a very simple test of the Graph API after login is
		// successful. See statusChangeCallback() for when this call is made.
		function testAPI() {
			console.log('Welcome! Fetching your information.... ');
			FB
					.api(
							'/me',
							function(response) {
								console.log('Successful login for: '
										+ response.name);
								document.getElementById('status').innerHTML = 'Thanks for logging in, '
										+ response.name + '!';
							});
		}
		// This function reads your Facebook groups.
		function getMyGroups() {
			FB.api('/me/groups', function(response) {
				var groupList = document.getElementById('groups');
				response.data.forEach(function(group) {
					var opt = document.createElement("option");
					opt.value = group.id;
					opt.innerHTML = group.name;
					groupList.appendChild(opt);
				});
			}, {
				scope : 'user_groups,publish_actions'
			});
		}
		function postToSelectedGroups() {
			var groupList = document.getElementById('groups');
			var selectedGroupIds = [];
			for (var i = 0; i < groupList.length; i++) {
				if (groupList[i].selected) {
					selectedGroupIds.push(groupList[i].value);
				}
			}
			var delay = parseInt(document.getElementById("delay").value, 10);
			function postOrFinish() {
				if (selectedGroupIds.length > 0) {
					var groupId = selectedGroupIds.pop();
					var message = document.getElementById("message").value;
					var link = document.getElementById("link").value;
					var image = document.getElementById("image").value;
					FB.api("/" + groupId + "/feed", "POST", {
						"message" : message,
						"link" : link
					//"url" : image
					}, function(response) {
						if (response.error) {
							console.log(response.error);
						}
						setTimeout(postOrFinish, delay * 1000);
					});
				} else {
					alert('Postagens realizadas com sucesso!');
				}
			}
			postOrFinish();
		}

		function add_item() {
			$('ul#filterList')
					.append(
							"<li> <input type='text' value='' class='form-control' id='filter"+countFilters+"'> </li>");
			countFilters = countFilters + 1;
			event.preventDefault();
		}
		
		String.prototype.contains = function(it) { return this.indexOf(it) != -1; };
		
		function matchKeyword(text, keyword) {
			var textLow = text.toLowerCase();
			var keywordLow = keyword.toLowerCase();
			return textLow.contains(keywordLow);
		}
		
		function filterGroups()  {
			var list = document.getElementById("filterList");
			var listItem = list.getElementsByTagName("li");			
			var groups = document.getElementById("groups");
			for (var i=0; i < groups.length; i++){	
				var matched = false;
				var groupName = groups.options[i].innerHTML;
				for (var j=0; j < listItem.length; j++) {
					var keyword = listItem[j].getElementsByTagName("input")[0].getAttribute("value");
					if (matchKeyword(groupName, keyword)) {
						matched = true;
						break;
					}				
				}
				if (!matched) {
					groups.remove(i);
					i--;
				}
			}
		}
	</script>
	<div class="container">
		<br />
		<form class="form-horizontal" method="POST">
			<div class="form-group">
				<div class="col-lg-10 col-lg-offset-2">	
					<!--
							Below we include the Login Button social plugin. This button uses
							the JavaScript SDK to present a graphical Login button that triggers
							the FB.login() function when clicked.
							-->
					<fb:login-button
						scope="public_profile,email,user_groups,publish_actions"
						onlogin="checkLoginState();"></fb:login-button>
					<div id="status"></div>
				</div>
			</div>
			<div class="form-group">
				<label for="message" class="col-lg-2 control-label">Mensagem</label>
				<div class="col-lg-10">
					<textarea class="form-control" rows="3"
						placeholder="Digite sua mensagem aqui." id="message"></textarea>
				</div>
			</div>
			<div class="form-group">
				<label for="link" class="col-lg-2 control-label">Link</label>
				<div class="col-lg-10">
					<input type="text" value="" class="form-control" id="link"
						placeholder="Coloque seu link aqui.">
				</div>
			</div>
			<div class="form-group">
				<label for="groupsFilter" class="col-lg-2 control-label">Filtrar
					grupos</label>
				<div class="col-lg-10">
					 <ul class='list' id='filterList'>
					 <li> <input type="text" value="espiritismo" class="form-control" id="filter0"> </li>
					 <li> <input type="text" value="espírita" class="form-control" id="filter1"></li>
					 <li> <input type="text" value="espirituali" class="form-control" id="filter2"> </li>
					 <li> <input type="text" value="rosa" class="form-control" id="filter3"> </li>
      				</ul>
      				 <input type="submit" value="Adicionar filtro" id="addFilter" />
      				 <input type="submit" value="Filtrar grupos" id="filterGroups" />
				</div>
			</div>

			<div class="form-group">
				<label for="groups" class="col-lg-2 control-label">Grupos</label>
				<div class="col-lg-10">
					<select multiple="" class="form-control" id="groups">
					</select> <span class="help-block">Selecione seus grupos</span>
					<button type="button" onclick="getMyGroups();"
						class="btn btn-success">Mostrar grupos</button>
				</div>
			</div>
			<div class="form-group">
				<label for="delay" class="col-lg-2 control-label">Atraso
					entre postagens</label>
				<div class="col-lg-10">
					<input type="text" value="10" class="form-control" id="delay">
					<span class="help-block">Número de segundos entre postagens.</span>
				</div>
			</div>
			<div class="form-group">
				<div class="col-lg-10 col-lg-offset-2">
					<button type="button" onclick="postToSelectedGroups();"
						class="btn btn-primary">Postar nos grupos</button>
				</div>
			</div>
		</form>
	</div>
</body>
</html>
